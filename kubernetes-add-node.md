# 添加 Node 节点到 Kubernetes 集群

## 一、安装 Kubernetes 环境所需要的组件（新的节点）

具体步骤请参考 《Kubernetes 集群环境安装搭建》一文安装 docker kubelet kubeadm kubectl 组件，此处不再叙述

## 二、生成 token（Kubernetes-master 节点）

推荐生成 临时 `token` 的方式，提高集群安全性，按需生成,有效期为1天

- 永久 `token` 生成

不安全不推荐，通过命令生成永久token，不会过期

```kubeadm token create --ttl 0```

```bbcns1.mj6itpza9b5qea2l```

- 临时 `token` 生成

```kubeadm token create```

```dr4woa.ywa9twfuwomtg1np```

```kubeadm token list```

EXPIRES 值为过期时间 (UTC)

```
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
bbcns1.mj6itpza9b5qea2l   <forever>   <never>                authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token
dr4woa.ywa9twfuwomtg1np   23h         2019-09-26T11:11:35Z   authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token
p3ldew.ciwtmgr6pvnvi5xr   23h         2019-09-26T11:11:28Z   authentication,signing   <none>                                                     system:bootstrappers:kubeadm:default-node-token
pihjd2.1w4blf6pftxnpiia   29m         2019-09-25T11:55:40Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```
记录生成的 `token`

## 三、获取 ca 证书 sha256 编码 hash 值（Kubernetes-master 节点）

默认`ca`证书存放在`/etc/kubernetes/pki`目录下

```openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'```

```3920ef4600ab1034ff3d7ca2a8aed7b812203014a97790e81a5eaf0c16941ded```

记录 `ca` 哈希值

## 四、通过新生成的 token 和 ca 证书 sha256 编码 hash 值 添加节点到集群（新的节点）

通过上文记录内容组成命令

join [Kubernetes-master的IPv4] 端口：6443

```
kubeadm join xxx.xxx.xxx.240:6443 \
    --token dr4woa.ywa9twfuwomtg1np \
    --discovery-token-ca-cert-hash sha256:3920ef4600ab1034ff3d7ca2a8aed7b812203014a97790e81a5eaf0c16941ded
```

```
[preflight] Running pre-flight checks
	[WARNING IsDockerSystemdCheck]: detected "cgroupfs" as the Docker cgroup driver. The recommended driver is "systemd". Please follow the guide at https://kubernetes.io/docs/setup/cri/
[preflight] Reading configuration from the cluster...
[preflight] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[kubelet-start] Downloading configuration for the kubelet from the "kubelet-config-1.16" ConfigMap in the kube-system namespace
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/config.yaml"
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib/kubelet/kubeadm-flags.env"
[kubelet-start] Activating the kubelet service
[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...

This node has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run 'kubectl get nodes' on the control-plane to see this node join the cluster.
```

恭喜你已成功添加一个节点到 Kubernetes 集群